# Takt.Net 配置说明

## 配置文件说明

### 配置文件结构

项目包含以下配置文件：

1. **`appsettings.json`** - 通用配置文件（基础配置）
   - 包含所有环境的通用配置项
   - 不包含敏感信息（如数据库连接字符串）
   - 包含：日志配置、安全配置、认证配置、账户锁定配置等

2. **`appsettings.Development.json`** - 开发环境配置文件
   - 仅包含开发环境特定的配置
   - 主要包含：开发环境的数据库连接字符串
   - 会覆盖 `appsettings.json` 中的同名配置项

3. **`appsettings.Production.json`** - 生产环境配置文件
   - 仅包含生产环境特定的配置
   - 主要包含：生产环境的数据库连接字符串
   - 会覆盖 `appsettings.json` 中的同名配置项

4. **`appsettings.example.json`** - 示例配置文件（模板）
   - 包含完整的配置示例
   - 不包含真实的敏感信息（密码等用占位符代替）
   - 用于参考和快速创建实际配置文件

### Git Clone 后的配置步骤

当您从 Git 仓库克隆项目后，需要根据 `appsettings.example.json` 模板创建实际的配置文件。按照以下步骤操作：

#### 步骤 1：复制模板文件

```bash
# 进入项目目录
cd backend/src/Takt.WebApi

# 复制示例配置文件为实际配置文件
cp appsettings.example.json appsettings.json
cp appsettings.example.json appsettings.Development.json
cp appsettings.example.json appsettings.Production.json
```

#### 步骤 2：创建通用配置文件（appsettings.json）

编辑 `appsettings.json`，**删除**以下配置项（这些应该在环境特定配置文件中）：
- `dbConfigs` - 数据库配置数组
- `OpenIddictDb` - OpenIddict 数据库连接字符串

**保留并修改**以下配置项：

1. **`Environment`** - 设置默认运行环境
   ```json
   "Environment": "Development"  // 或 "Production"
   ```

2. **`Cors.AllowedOrigins`** - 配置允许的前端地址（如果模板中没有，需要添加）
   ```json
   "Cors": {
     "AllowedOrigins": [
       "http://localhost:60080",
       "https://localhost:60081"
     ]
   }
   ```

3. **`Swagger.Enabled`** - 是否启用Swagger UI（如果模板中没有，需要添加）
   ```json
   "Swagger": {
     "Enabled": true
   }
   ```

4. **其他通用配置**（通常不需要修改，除非有特殊需求）：
   - `Snowflake.WorkId` - 雪花ID工作节点ID
   - `Security.RateLimit` - 速率限制配置
   - `Authentication` - 认证相关配置
   - `AccountLock` - 账户锁定配置
   - `Init.InitDb` - 数据库初始化开关
   - `Init.SeedData` - 种子数据初始化开关
   - `ShowDbLog` - 数据库日志输出开关

**最终 `appsettings.json` 应该包含：**
- `AllowedHosts`
- `Serilog`
- `Tenant`
- `Init`
- `SingleLogin`
- `ShowDbLog`
- `DemoMode`
- `Environment`
- `Logging`
- `Snowflake`
- `PasswordPolicy`
- `TaktExcelOptions`
- `Security`
- `Authentication`
- `AccountLock`
- `Cors`
- `Swagger`

**不应该包含：**
- `dbConfigs`
- `OpenIddictDb`

#### 步骤 3：创建开发环境配置文件（appsettings.Development.json）

编辑 `appsettings.Development.json`，**删除所有配置项**，**只保留**数据库连接配置：

```json
{
  "dbConfigs": [
    {
      "Conn": "Server=your-dev-server;Database=Takt_Identity_Dev;User Id=sa;Password=your-dev-password;TrustServerCertificate=true;",
      "DbType": 1,
      "ConfigId": "0",
      "IsAutoCloseConnection": true
    },
    {
      "Conn": "Server=your-dev-server;Database=Takt_Accounting_Dev;User Id=sa;Password=your-dev-password;TrustServerCertificate=true;",
      "DbType": 1,
      "ConfigId": "1",
      "IsAutoCloseConnection": true
    },
    {
      "Conn": "Server=your-dev-server;Database=Takt_HumanResource_Dev;User Id=sa;Password=your-dev-password;TrustServerCertificate=true;",
      "DbType": 1,
      "ConfigId": "2",
      "IsAutoCloseConnection": true
    },
    {
      "Conn": "Server=your-dev-server;Database=Takt_Logistics_Dev;User Id=sa;Password=your-dev-password;TrustServerCertificate=true;",
      "DbType": 1,
      "ConfigId": "3",
      "IsAutoCloseConnection": true
    },
    {
      "Conn": "Server=your-dev-server;Database=Takt_Building_Dev;User Id=sa;Password=your-dev-password;TrustServerCertificate=true;",
      "DbType": 1,
      "ConfigId": "4",
      "IsAutoCloseConnection": true
    },
    {
      "Conn": "Server=your-dev-server;Database=Takt_Routine_Dev;User Id=sa;Password=your-dev-password;TrustServerCertificate=true;",
      "DbType": 1,
      "ConfigId": "5",
      "IsAutoCloseConnection": true
    }
  ],
  "OpenIddictDb": "Server=your-dev-server;Database=Takt_Net_Oidc;User Id=sa;Password=your-dev-password;TrustServerCertificate=true;"
}
```

**重要提示：**
- 将 `your-dev-server` 替换为实际的开发环境数据库服务器地址
- 将 `your-dev-password` 替换为实际的数据库密码
- 根据实际情况修改数据库名称（如果与模板不同）
- **不要包含** `Environment` 字段
- **不要包含**其他任何通用配置项

#### 步骤 4：创建生产环境配置文件（appsettings.Production.json）

编辑 `appsettings.Production.json`，**删除所有配置项**，**只保留**数据库连接配置：

```json
{
  "dbConfigs": [
    {
      "Conn": "Server=your-prod-server;Database=Takt_Identity_Prod;User Id=sa;Password=your-prod-password;TrustServerCertificate=true;",
      "DbType": 1,
      "ConfigId": "0",
      "IsAutoCloseConnection": true
    },
    {
      "Conn": "Server=your-prod-server;Database=Takt_Accounting_Prod;User Id=sa;Password=your-prod-password;TrustServerCertificate=true;",
      "DbType": 1,
      "ConfigId": "1",
      "IsAutoCloseConnection": true
    },
    {
      "Conn": "Server=your-prod-server;Database=Takt_HumanResource_Prod;User Id=sa;Password=your-prod-password;TrustServerCertificate=true;",
      "DbType": 1,
      "ConfigId": "2",
      "IsAutoCloseConnection": true
    },
    {
      "Conn": "Server=your-prod-server;Database=Takt_Logistics_Prod;User Id=sa;Password=your-prod-password;TrustServerCertificate=true;",
      "DbType": 1,
      "ConfigId": "3",
      "IsAutoCloseConnection": true
    },
    {
      "Conn": "Server=your-prod-server;Database=Takt_Building_Prod;User Id=sa;Password=your-prod-password;TrustServerCertificate=true;",
      "DbType": 1,
      "ConfigId": "4",
      "IsAutoCloseConnection": true
    },
    {
      "Conn": "Server=your-prod-server;Database=Takt_Routine_Prod;User Id=sa;Password=your-prod-password;TrustServerCertificate=true;",
      "DbType": 1,
      "ConfigId": "5",
      "IsAutoCloseConnection": true
    }
  ],
  "OpenIddictDb": "Server=your-prod-server;Database=Takt_Net_Oidc;User Id=sa;Password=your-prod-password;TrustServerCertificate=true;"
}
```

**重要提示：**
- 将 `your-prod-server` 替换为实际的生产环境数据库服务器地址
- 将 `your-prod-password` 替换为实际的生产环境数据库密码
- 根据实际情况修改数据库名称（通常生产环境数据库名称与开发环境不同）
- **不要包含** `Environment` 字段
- **不要包含**其他任何通用配置项

#### 步骤 5：验证配置并启动程序

1. **检查配置文件结构**
   - `appsettings.json` - 包含通用配置，不包含数据库连接
   - `appsettings.Development.json` - 只包含开发环境数据库连接
   - `appsettings.Production.json` - 只包含生产环境数据库连接

2. **启动应用程序**
   ```bash
   dotnet run
   ```

3. **检查启动日志**，确认以下信息：
   - ✅ `Environment - 运行环境: Development`（或 Production）
   - ✅ 数据库连接成功（没有连接错误）
   - ✅ 所有配置项都已正确加载
   - ✅ 应用程序启动完成

4. **如果出现错误**：
   - **数据库连接失败**：检查 `appsettings.{Environment}.json` 中的数据库连接字符串是否正确
   - **配置项未找到**：检查 `appsettings.json` 中是否包含所有必需的配置项
   - **环境配置错误**：检查 `appsettings.json` 中的 `Environment` 字段是否正确

#### 快速检查清单

- [ ] `appsettings.json` 已创建，包含通用配置，**不包含** `dbConfigs` 和 `OpenIddictDb`
- [ ] `appsettings.Development.json` 已创建，**只包含** `dbConfigs` 和 `OpenIddictDb`，已替换为实际的开发环境数据库信息
- [ ] `appsettings.Production.json` 已创建，**只包含** `dbConfigs` 和 `OpenIddictDb`，已替换为实际的生产环境数据库信息
- [ ] 所有数据库连接字符串中的服务器地址、数据库名称、用户名、密码都已正确配置
- [ ] `appsettings.json` 中的 `Environment` 字段已设置为正确的环境值
- [ ] `appsettings.json` 中已添加 `Cors.AllowedOrigins` 配置（如果模板中没有）
- [ ] `appsettings.json` 中已添加 `Swagger.Enabled` 配置（如果模板中没有）

### 配置文件加载顺序

ASP.NET Core 按以下顺序加载配置文件（后面的配置会覆盖前面的）：

1. `appsettings.json`（基础配置）
2. `appsettings.{Environment}.json`（环境特定配置，根据 `Environment` 字段或 `ASPNETCORE_ENVIRONMENT` 环境变量）
3. 环境变量
4. 命令行参数

**最佳实践：**
- 通用配置放在 `appsettings.json`
- 环境特定配置（主要是数据库连接）放在 `appsettings.{Environment}.json`
- 敏感信息（如密码）使用环境变量或密钥管理服务

## 多租户配置

### 禁用多租户

要禁用多租户功能，请在 `appsettings.json` 中设置：

```json
{
  "UseTenant": 0
}
```

**说明：**
- `UseTenant: 0` - 不启用多租户，系统将始终使用 `MainDb` 指定的主库配置
- `UseTenant: 1` - 启用多租户，系统会根据请求中的 `ConfigId` 动态切换数据库

### 启用多租户

要启用多租户功能，请在 `appsettings.json` 中设置：

```json
{
  "UseTenant": 1
}
```

启用后，系统会：
1. 从 HTTP Header `X-Config-Id` 或 Query 参数 `configId` 获取 ConfigId
2. 如果未提供 ConfigId，则使用 `MainDb` 指定的主库
3. 根据 ConfigId 切换到对应的数据库连接

## 配置项说明

### dbConfigs

数据库配置数组，每个配置项包含：

- `Conn` - 数据库连接字符串
- `DbType` - 数据库类型（0=MySql, 1=SqlServer, 3=Oracle, 4=PostgreSQL）
- `ConfigId` - 多租户唯一标识（用于区分不同的数据库连接）
- `IsAutoCloseConnection` - 是否自动关闭连接（建议设为 true）

### MainDb

主库的 ConfigId，当多租户未启用或未提供 ConfigId 时使用。

### UseTenant

多租户开关：
- `0` - 不启用多租户
- `1` - 启用多租户

### ConfigIdHeaderName

HTTP Header 名称，用于传递 ConfigId（默认：`X-Config-Id`）

### ConfigIdQueryName

Query 参数名称，用于传递 ConfigId（默认：`configId`）

### InitDb

数据库初始化开关：
- `false` - 不初始化数据库（默认）
- `true` - 初始化数据库（创建数据库和表结构）

**注意：** 设置为 `true` 时，系统启动时会自动创建数据库（如果不存在）和所有表结构。

### SeedData

种子数据初始化开关：
- `false` - 不初始化种子数据（默认）
- `true` - 初始化种子数据（创建默认租户和管理员用户）

**注意：** 设置为 `true` 时，系统启动时会自动创建：
- 默认租户（Code: "default", Name: "默认租户"）
- 默认管理员用户（UserName: "admin", Password: "admin123"）

**重要提示：** 种子数据初始化会检查数据是否已存在，如果已存在则不会重复创建。

### SingleLogin

单点登录开关：
- `false` - 允许多设备/浏览器同时登录（默认）
- `true` - 只允许单设备/浏览器登录（新登录会踢掉旧登录）

**注意：** 此配置需要在认证模块中实现具体逻辑。

### ShowDbLog

数据库日志输出开关：
- `false` - 不输出数据库日志（默认）
- `true` - 输出数据库日志（SQL语句和参数）

**注意：** 设置为 `true` 时，会在控制台和日志文件中输出所有执行的SQL语句和参数，方便调试和排查问题。

### workId

雪花ID工作节点ID：
- 范围：1-1023
- 默认值：1

**说明：** 雪花ID用于生成唯一的长整型ID。在分布式系统中，每个服务实例应该使用不同的 `workId` 以确保生成的ID唯一。建议：
- 单机部署：使用默认值 1
- 分布式部署：为每个服务实例分配不同的 workId（1-1023）

## 使用示例

### 禁用多租户

```json
{
  "dbConfigs": [
    {
      "Conn": "Server=localhost;Database=TaktDb;...",
      "DbType": 1,
      "ConfigId": "0",
      "IsAutoCloseConnection": true
    }
  ],
  "MainDb": "0",
  "UseTenant": 0
}
```

### 启用多租户

```json
{
  "dbConfigs": [
    {
      "Conn": "Server=localhost;Database=TaktDb;...",
      "DbType": 1,
      "ConfigId": "0",
      "IsAutoCloseConnection": true
    },
    {
      "Conn": "Server=localhost;Database=TaktDb_Tenant1;...",
      "DbType": 1,
      "ConfigId": "1",
      "IsAutoCloseConnection": true
    }
  ],
  "MainDb": "0",
  "UseTenant": 1
}
```

启用后，可以通过以下方式指定数据库：

1. **HTTP Header**：`X-Config-Id: 1`
2. **Query 参数**：`?configId=1`
3. **默认**：如果不提供，使用 `MainDb` 指定的主库

## 账户锁定配置

### AccountLock

账户自动锁定配置：

```json
{
  "AccountLock": {
    "Enabled": true,
    "ErrorLimit": 5,
    "LockReason": "连续登录失败{ErrorCount}次，达到错误次数限制（{ErrorLimit}次）"
  }
}
```

**配置项说明：**

- `Enabled` - 是否启用账户锁定功能
  - `true` - 启用（默认）
  - `false` - 禁用（禁用后登录失败不会增加失败次数，也不会锁定账户）

- `ErrorLimit` - 登录失败次数限制
  - 默认值：`5`
  - 说明：连续登录失败达到此次数时，系统会自动锁定账户

- `LockReason` - 锁定原因模板
  - 默认值：`"连续登录失败{ErrorCount}次，达到错误次数限制（{ErrorLimit}次）"`
  - 说明：支持占位符 `{ErrorCount}`（失败次数）和 `{ErrorLimit}`（错误限制）

**重要提示：**
- 账户锁定只能由系统自动触发（登录失败次数达到限制时）
- 管理员无法手动锁定账户
- 解锁账户需要通过管理员操作，解锁时会自动重置失败次数
