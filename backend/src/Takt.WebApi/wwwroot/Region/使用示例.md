# IP定位功能使用示例

## 一、基本使用

### 1. 查询单个IP地址
```csharp
// 查询IPv4地址
string ip = "114.114.114.114";
IpLocationResult? result = TaktLocationHelper.Search(ip);

if (result != null)
{
    Console.WriteLine($"IP: {result.Ip}");
    Console.WriteLine($"国家: {result.Country}");
    Console.WriteLine($"省份: {result.Province}");
    Console.WriteLine($"城市: {result.City}");
    Console.WriteLine($"ISP: {result.Isp}");
    Console.WriteLine($"完整地址: {result.FullAddress}");
    Console.WriteLine($"格式化地址: {result.FormattedAddress}");
}
else
{
    Console.WriteLine("未找到该IP地址的位置信息");
}
```

### 2. 异步查询
```csharp
string ip = "114.114.114.114";
IpLocationResult? result = await TaktLocationHelper.SearchAsync(ip);
```

### 3. 批量查询
```csharp
var ips = new List<string> { "114.114.114.114", "8.8.8.8", "1.1.1.1" };
Dictionary<string, IpLocationResult?> results = TaktLocationHelper.BatchSearch(ips);

foreach (var kvp in results)
{
    if (kvp.Value != null)
    {
        Console.WriteLine($"{kvp.Key}: {kvp.Value.FormattedAddress}");
    }
}
```

### 4. 批量异步查询
```csharp
var ips = new List<string> { "114.114.114.114", "8.8.8.8", "1.1.1.1" };
Dictionary<string, IpLocationResult?> results = await TaktLocationHelper.BatchSearchAsync(ips);
```

## 二、在业务代码中使用

### 示例1：登录日志记录IP位置
```csharp
public async Task<TaktLoginResultDto> LoginAsync(TaktLoginDto dto, HttpContext httpContext)
{
    // 获取客户端IP
    var clientIp = GetClientIpAddress(httpContext);
    
    // 查询IP位置
    if (!string.IsNullOrEmpty(clientIp))
    {
        var location = TaktLocationHelper.Search(clientIp);
        if (location != null)
        {
            TaktLogger.Information("用户登录，IP: {Ip}, 位置: {Location}", 
                clientIp, location.FormattedAddress);
            
            // 可以保存到登录日志表
            // loginLog.Location = location.FormattedAddress;
        }
    }
    
    // 继续登录逻辑...
}
```

### 示例2：在线用户显示位置
```csharp
public async Task<TaktOnlineDto> CreateAsync(TaktOnlineCreateDto dto)
{
    // 查询IP位置
    if (!string.IsNullOrWhiteSpace(dto.ConnectIp))
    {
        var location = TaktLocationHelper.Search(dto.ConnectIp);
        if (location != null)
        {
            dto.ConnectLocation = location.FormattedAddress;
        }
    }
    
    // 继续创建在线用户记录...
}
```

### 示例3：操作日志记录位置
```csharp
public void LogOperation(string operation, HttpContext context)
{
    var clientIp = GetClientIpAddress(context);
    var location = !string.IsNullOrEmpty(clientIp) 
        ? TaktLocationHelper.Search(clientIp) 
        : null;
    
    var logEntry = new OperationLog
    {
        Operation = operation,
        IpAddress = clientIp,
        Location = location?.FormattedAddress ?? "未知",
        Country = location?.Country,
        Province = location?.Province,
        City = location?.City
    };
    
    // 保存日志...
}
```

### 示例4：IP归属地验证
```csharp
public bool ValidateIpLocation(string ip, string expectedCountry)
{
    var location = TaktLocationHelper.Search(ip);
    if (location == null)
    {
        return false;
    }
    
    return location.Country.Equals(expectedCountry, StringComparison.OrdinalIgnoreCase);
}
```

## 三、IP地址获取方法

### 从HttpContext获取客户端IP
```csharp
private static string? GetClientIpAddress(HttpContext context)
{
    // 优先从 X-Forwarded-For 头获取（适用于反向代理场景）
    var forwardedFor = context.Request.Headers["X-Forwarded-For"].FirstOrDefault();
    if (!string.IsNullOrEmpty(forwardedFor))
    {
        // X-Forwarded-For 可能包含多个IP，取第一个
        var ips = forwardedFor.Split(',');
        if (ips.Length > 0)
        {
            return ips[0].Trim();
        }
    }

    // 从 X-Real-IP 头获取
    var realIp = context.Request.Headers["X-Real-IP"].FirstOrDefault();
    if (!string.IsNullOrEmpty(realIp))
    {
        return realIp;
    }

    // 从连接信息获取
    return context.Connection.RemoteIpAddress?.ToString();
}
```

## 四、初始化配置

IP定位数据库在 `Program.cs` 中自动初始化：

```csharp
// 初始化IP定位数据库（从文件加载）
var contentRoot = builder.Environment.ContentRootPath;
var ipv4DbPath = Path.Combine(contentRoot, "wwwroot", "Region", "ip2region_v4.xdb");
var ipv6DbPath = Path.Combine(contentRoot, "wwwroot", "Region", "ip2region_v6.xdb");

if (File.Exists(ipv4DbPath))
{
    var ipv6Path = File.Exists(ipv6DbPath) ? ipv6DbPath : null;
    TaktLocationHelper.Initialize(ipv4DbPath, ipv6Path);
}
```

## 五、数据库文件说明

### 文件位置
- **IPv4数据库**: `wwwroot/Region/ip2region_v4.xdb`
- **IPv6数据库**: `wwwroot/Region/ip2region_v6.xdb`（可选）

### 数据格式
- XDB格式是IP2Region的专用数据格式
- 支持亿级别的IP数据段管理
- 查询性能达到微秒级别

### 数据来源
- 官方数据源：https://ip2region.net/
- GitHub仓库：https://github.com/lionsoul2014/ip2region
- 可以下载最新的XDB数据文件进行更新

## 六、返回结果说明

### IpLocationResult 属性
- **Ip**: IP地址
- **Country**: 国家
- **Region**: 区域（省/州）
- **Province**: 省份
- **City**: 城市
- **Isp**: 互联网服务提供商
- **FullAddress**: 完整地址信息（格式：国家|区域|省份|城市|ISP）
- **FormattedAddress**: 格式化地址（用于显示，自动拼接国家、省份、城市、ISP）

### 结果示例
```csharp
{
    "Ip": "114.114.114.114",
    "Country": "中国",
    "Region": "华东",
    "Province": "江苏省",
    "City": "南京市",
    "Isp": "电信",
    "FullAddress": "中国|华东|江苏省|南京市|电信",
    "FormattedAddress": "中国 江苏省 南京市 电信"
}
```

## 七、性能说明

- **查询速度**: 微秒级别（10微秒左右）
- **内存占用**: 根据缓存策略不同，约几MB到几十MB
- **支持规模**: 亿级别的IP数据段
- **线程安全**: 支持并发查询

## 八、注意事项

1. **数据库文件**: 确保XDB文件存在且可读，否则初始化会失败
2. **IPv6支持**: IPv6数据库是可选的，如果不存在，IPv6地址查询会返回null
3. **IP格式验证**: 方法内部会自动验证IP地址格式，无效格式会返回null
4. **初始化时机**: 数据库在应用启动时自动初始化，无需手动调用
5. **错误处理**: 查询失败时返回null，不会抛出异常（除非未初始化）
6. **缓存策略**: 使用 `CachePolicy.Content` 策略，将整个数据库加载到内存，查询速度最快

## 九、常见问题

### Q: 查询返回null怎么办？
A: 可能的原因：
- IP地址格式不正确
- 数据库文件中没有该IP的记录
- 数据库未正确初始化

### Q: 如何更新数据库？
A: 
1. 从 https://ip2region.net/ 或 GitHub 下载最新的XDB文件
2. 替换 `wwwroot/Region/` 目录下的文件
3. 重启应用程序（会自动重新加载）

### Q: 支持IPv6吗？
A: 支持，但需要提供IPv6数据库文件（ip2region_v6.xdb）。如果文件不存在，IPv6地址查询会返回null。

### Q: 性能如何？
A: 使用Content缓存策略，查询速度达到微秒级别，适合高并发场景。
