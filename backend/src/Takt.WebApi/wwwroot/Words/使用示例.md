# 敏感词过滤使用示例

## 一、用户名称过滤（已集成）

### 自动验证
在创建或更新用户时，系统会自动验证以下字段是否包含敏感词：
- **用户名** (UserName)
- **真实姓名** (RealName)
- **全名** (FullName)
- **昵称** (NickName)
- **英文名称** (EnglishName)

### 验证时机
- **创建用户**：`TaktUserService.CreateAsync()` 方法中自动验证
- **更新用户**：`TaktUserService.UpdateAsync()` 方法中自动验证

### 错误提示
如果包含敏感词，系统会抛出 `TaktBusinessException` 异常，提示信息格式：
```
用户名包含敏感词：xxx、yyy，请修改后重试
真实姓名包含敏感词：xxx、yyy，请修改后重试
昵称包含敏感词：xxx、yyy，请修改后重试
```

### 示例代码
```csharp
// 创建用户时自动验证
var createDto = new TaktUserCreateDto
{
    UserName = "testuser",      // 如果包含敏感词会抛出异常
    RealName = "张三",          // 如果包含敏感词会抛出异常
    FullName = "张三",          // 如果包含敏感词会抛出异常
    NickName = "昵称",          // 如果包含敏感词会抛出异常
    EnglishName = "John"        // 如果包含敏感词会抛出异常
};

try
{
    var user = await _userService.CreateAsync(createDto);
}
catch (TaktBusinessException ex)
{
    // 异常消息：用户名包含敏感词：xxx，请修改后重试
    Console.WriteLine(ex.Message);
}
```

## 二、其他场景使用

### 1. 检查文本是否包含敏感词
```csharp
string text = "这是一段测试文本";
bool hasIllegal = TaktWordFilterHelper.ContainsIllegalWords(text);
if (hasIllegal)
{
    // 包含敏感词，拒绝操作
    throw new TaktBusinessException("内容包含敏感词，请修改后重试");
}
```

### 2. 查找所有敏感词
```csharp
string text = "这是一段包含敏感词的文本";
List<string> illegalWords = TaktWordFilterHelper.FindAllIllegalWords(text);
// 返回：["敏感词1", "敏感词2"]
```

### 3. 替换敏感词
```csharp
string text = "这是一段包含敏感词的文本";
string filtered = TaktWordFilterHelper.ReplaceIllegalWords(text, '*');
// 结果：这是一段包含****的文本

// 或使用自定义替换文本
string filtered2 = TaktWordFilterHelper.ReplaceIllegalWords(text, "***");
// 结果：这是一段包含***的文本
```

### 4. 高亮敏感词（HTML）
```csharp
string text = "这是一段包含敏感词的文本";
string highlighted = TaktWordFilterHelper.HighlightIllegalWords(text, "illegal-word");
// 结果：这是一段包含<span class="illegal-word">敏感词</span>的文本
```

## 三、在业务代码中使用

### 示例1：评论内容过滤
```csharp
public async Task<CommentDto> CreateCommentAsync(CommentCreateDto dto)
{
    // 验证评论内容
    if (TaktWordFilterHelper.ContainsIllegalWords(dto.Content))
    {
        var illegalWords = TaktWordFilterHelper.FindAllIllegalWords(dto.Content);
        throw new TaktBusinessException($"评论内容包含敏感词：{string.Join("、", illegalWords)}，请修改后重试");
    }
    
    // 或者自动替换敏感词
    dto.Content = TaktWordFilterHelper.ReplaceIllegalWords(dto.Content, '*');
    
    // 继续创建评论...
}
```

### 示例2：文章标题过滤
```csharp
public async Task<ArticleDto> CreateArticleAsync(ArticleCreateDto dto)
{
    // 验证标题和内容
    ValidateTextForSensitiveWords(dto.Title, "标题");
    ValidateTextForSensitiveWords(dto.Content, "内容");
    
    // 继续创建文章...
}

private static void ValidateTextForSensitiveWords(string text, string fieldName)
{
    if (string.IsNullOrWhiteSpace(text))
        return;
        
    if (TaktWordFilterHelper.ContainsIllegalWords(text))
    {
        var illegalWords = TaktWordFilterHelper.FindAllIllegalWords(text);
        throw new TaktBusinessException($"{fieldName}包含敏感词：{string.Join("、", illegalWords)}，请修改后重试");
    }
}
```

### 示例3：消息内容过滤
```csharp
public async Task SendMessageAsync(MessageCreateDto dto)
{
    // 自动过滤敏感词
    dto.Content = TaktWordFilterHelper.ReplaceIllegalWords(dto.Content, '*');
    
    // 记录被过滤的敏感词（用于审核）
    var illegalWords = TaktWordFilterHelper.FindAllIllegalWords(dto.OriginalContent);
    if (illegalWords.Any())
    {
        TaktLogger.Warning("消息内容包含敏感词，已自动过滤。敏感词: {Words}, 用户: {User}", 
            string.Join(", ", illegalWords), dto.UserId);
    }
    
    // 继续发送消息...
}
```

## 四、初始化配置

敏感词库在 `Program.cs` 中自动初始化：

```csharp
// 初始化敏感词库（从文件加载）
var contentRoot = builder.Environment.ContentRootPath;
var sensitiveWordsPath = Path.Combine(contentRoot, "wwwroot", "Words", "sensitive-words.txt");

if (File.Exists(sensitiveWordsPath))
{
    TaktWordFilterHelper.LoadFromFile(sensitiveWordsPath);
}
else
{
    // 使用空词库初始化
    TaktWordFilterHelper.Initialize(new List<string>());
}
```

## 五、动态管理敏感词

### 添加敏感词
```csharp
var newWords = new List<string> { "新敏感词1", "新敏感词2" };
TaktWordFilterHelper.AddSensitiveWords(newWords);
```

### 移除敏感词
```csharp
var wordsToRemove = new List<string> { "敏感词1", "敏感词2" };
TaktWordFilterHelper.RemoveSensitiveWords(wordsToRemove);
```

### 获取敏感词数量
```csharp
int count = TaktWordFilterHelper.GetSensitiveWordsCount();
```

### 获取所有敏感词
```csharp
var allWords = TaktWordFilterHelper.GetAllSensitiveWords();
```

## 六、性能说明

- **AC自动机算法**：时间复杂度 O(n + m)，n为文本长度，m为敏感词总长度
- **支持多语言**：中文、英文、日语、韩语、俄语、法语、德语、西班牙语等
- **线程安全**：使用 lock 保护，支持并发访问
- **内存占用**：根据敏感词数量动态分配，约数万词库占用几MB内存

## 七、注意事项

1. **敏感词库初始化**：应用启动时自动加载，如果文件不存在会使用空词库
2. **实时生效**：添加或移除敏感词后立即生效，无需重启应用
3. **大小写敏感**：默认区分大小写，如需忽略大小写，可在使用前转换为统一大小写
4. **多语言支持**：支持中文、英文、日语、韩语等多种语言的敏感词检测
5. **业务场景**：根据实际业务需求调整敏感词库内容
