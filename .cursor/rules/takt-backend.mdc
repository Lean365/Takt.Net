---
description: Takt 后端 C# / .NET 约定（backend/**/*.cs）
globs: backend/**/*.cs
alwaysApply: false
---

# Takt 后端规则

## 解决方案与项目

- **Takt.Domain**：实体(Entities)、仓储接口(Repositories)、领域接口(Interfaces)、扩展(Extensions)、验证(Validation)。实体继承 `TaktEntityBase`，使用 SqlSugar 的 `[SugarTable]`、`[SugarColumn]`、`[SugarIndex]`；主键/外键 long 使用 `[JsonConverter(typeof(ValueToStringConverter))]`。
- **Takt.Application**：DTO(Dtos)、服务接口与实现(Services)。服务继承 `TaktServiceBase`，接口以 `ITaktXxxService` 命名；DTO 命名：`TaktXxxDto`、`TaktXxxQueryDto`(继承 `TaktPagedQuery`)、`TaktCreateXxxDto`、`TaktUpdateXxxDto`、`TaktXxxExportDto`、`TaktXxxStatusDto` 等。
- **Takt.Infrastructure**：数据(Data)、仓储实现(Repositories)、中间件(Middleware)、依赖注入(DependencyInjection)、扩展(Extensions)、SignalR、租户(Tenant)、用户(User)等；实体表映射与种子在 Data 中，新增实体需在 `TaktEntityDatabaseMapping` 中符合 ConfigId 映射。
- **Takt.Shared**：模型(Models)、异常(Exceptions)、帮助类(Helpers)等；分页使用 `TaktPagedQuery`、`TaktPagedResult<T>`。
- **Takt.WebApi**：控制器(Controllers)、Program/配置；控制器继承 `TaktControllerBase`，使用 `[Route("api/[controller]")]`、`[TaktPermission]`、`[ApiModule]`。

## 命名空间与文件

- 命名空间与文件夹一致：实体 `Takt.Domain.Entities.{领域}`（如 HumanResource.Organization、Statistics.Logging）；DTO `Takt.Application.Dtos.{领域}`；服务接口/实现：部分为 `Takt.Application.{领域}`（如 Organization、Identity、Tenant、Accounting、Routine.Dict、Routine.I18n、Routine.Setting、Routine.SignalR、Logistics.Material、Logistics.Maintenance），部分为 `Takt.Application.Services.{领域}`（如 Captcha、Generator、Logging、Routine.Files）；控制器 `Takt.WebApi.Controllers.{领域}`。
- 类/接口名：公开类型统一 **Takt** 前缀；实体文件名单实体（如 `TaktDept.cs`），DTO 可多类一文件（如 `TaktDeptDtos.cs`）。

## 控制器约定

- 继承 `TaktControllerBase`；异常用 `HandleException(ex)` 返回；分页列表返回 `TaktPagedResult<T>`；需权限的方法加 `[TaktPermission("code", "描述")]`。
- 示例：`[HttpGet("list")]` 分页列表，`[HttpGet("{id}")]` 详情，`[HttpPost]` 创建，`[HttpPut("{id}")]` 更新，`[HttpDelete("{id}")]` 删除；导入/导出使用 `responseType: blob` 与 FormData/Query。

## 服务与异常

- 业务校验失败使用 `ThrowBusinessException(message)` 或 `ThrowBusinessExceptionLocalized(key, resourceType, args)`；实体存在性用 `EnsureEntityExists`/`EnsureEntityExistsLocalized`；用户/租户上下文用基类提供的 `GetCurrentUser`、`GetCurrentConfigId` 等。

## 实体与数据库

- 表名：小写下划线，如 `takt_humanresource_organization_dept`；列名小写下划线；索引在实体上用 `[SugarIndex]` 声明；新增实体需在 `TaktEntityDatabaseMapping` 中按命名空间映射到正确 ConfigId，并在 `TaktTableInitializer`/种子中注册（若项目中有）。
